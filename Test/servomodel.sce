///servomotor
xdel(winsid());
clear ;
clc;


clear 
///Servo model
A=[-2.00000000005751e+001    -1.04719755089633e+000     0.00000000000000e+000     0.00000000000000e+000     0.00000000000000e+000;
    1.90985931710274e+002    -2.00000000000000e-001    -1.06683333333333e+000     0.00000000000000e+000     2.13366666666666e+001;
    0.00000000000000e+000     6.00000000000001e+000     0.00000000000000e+000     0.00000000000000e+000     0.00000000000000e+000;
    0.00000000000000e+000     0.00000000000000e+000     1.06683333333333e+000    -2.50000000000000e+000    -2.13366666666666e+001;
    0.00000000000000e+000     0.00000000000000e+000     0.00000000000000e+000     6.00000000000001e+000     0.00000000000000e+000]
B=[
    1.00000000050712e+000;
    0.00000000000000e+000;
    0.00000000000000e+000;
    0.00000000000000e+000;
    0.00000000000000e+000;]
C=[0.00000000000000e+000     0.00000000000000e+000     1.11718525420157e+000     0.00000000000000e+000    -2.23437050840314e+001;
    0.00000000000000e+000     0.00000000000000e+000     0.00000000000000e+000     0.00000000000000e+000     1.00000000000000e+000]
    
D=[0.00000000000000e+000;
    0.00000000000000e+000;
   ]

C1=[0.00000000000000e+000     0.00000000000000e+000     0.00000000000000e+000     0.00000000000000e+000     1.00000000000000e+000;
    0.00000000000000e+000     0.00000000000000e+000     0.00000000000000e+000     1.00000000000000e+000     0.00000000000000e+000]

B1=[1.00000000050712e+000     0.00000000000000e+000;
    0.00000000000000e+000     0.00000000000000e+000;
    0.00000000000000e+000     0.00000000000000e+000;
    0.00000000000000e+000     -9.54929658551370e-001;
    0.00000000000000e+000     0.00000000000000e+000;]
D1=[    0.00000000000000e+000     0.00000000000000e+000;
    0.00000000000000e+000     0.00000000000000e+000;]


C=C1
//Discretization Approximate
Ts=0.01
Ak=(eye(size(A,1),size(A,1))+Ts*A)
Bk=Ts*B1
Ck=C1
Dk=D1

//Delta formulation
exec('mpcfunctions.sci')
[Adelta,Bdelta,Cdelta,Ddelta]=mpcdelta(Ak,Bk(:,1),Ck,Dk(:,1))


///observer with disturbance model


//observer with delta formulation

poles_obs=spec(Adelta)/10

L=ppol(Adelta',Cdelta',poles_obs)
L=L' 

sim_time=20
dt=0.05
N=int(sim_time/dt)
time_vec=[0:dt:(N-1)*dt]

xdata_p=zeros(size(Ak,1),N);
xdata_e=zeros(size(Adelta,1),N);
ydata_p=zeros(size(C,1),N);

xdata_p(:,1)=[0,0,0,0,0]' 

xdata_e(:,1)=[0,0,0,0,0,0]'

ydata_p(:,1)=Ck*xdata_p(:,1)

deltaU=zeros(1,N);
deltaU(1)=100
td=20
u=100

for i=1:N-1
    xdata_p(:,i+1)=Ak*xdata_p(:,i)+Bk*[u;td]
    ydata_p(:,i+1)=Ck*xdata_p(:,i)
    xdata_e(:,i+1)=Adelta*xdata_e(:,i)+Bdelta*deltaU(i)+L*(ydata_p(:,i)-Cdelta*xdata_e(:,i))
end

plot(time_vec,xdata_p(2,:),time_vec,xdata_e(2,:))


//plot(time_vec,xdata_e(6,:))
